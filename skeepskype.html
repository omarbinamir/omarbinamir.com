<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Skeep Talk</title>
  <link rel="stylesheet" href="STYLERA.CSS" />
</head>
<body class="chat-ui">
  <div class="sidebar">
    <h3>ðŸŽ§ Skeep Voice Chat</h3>
    <div>
      Your ID: <span id="my-id">Loading...</span>
      <button onclick="copyMyId()">ðŸ“‹ Copy</button>
    </div>
    <input id="target-id" placeholder="Enter friend ID to call" />
    <button onclick="startCall()">ðŸ“ž Call Friend</button>
    <div id="recent-list"></div>
  </div>

  <div class="main">
    <video id="my-video" autoplay muted></video>
    <video id="their-video" autoplay></video>

    <div class="chat">
      <div id="chat-log"></div>
      <input id="chat-input" placeholder="Type message or emoji..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const myVideo = document.getElementById('my-video');
    const theirVideo = document.getElementById('their-video');
    const myIdDisplay = document.getElementById('my-id');
    const chatLog = document.getElementById('chat-log');

    let peer = new Peer();
    let localStream;
    let conn;

    peer.on('open', id => {
      myIdDisplay.textContent = id;
      localStorage.setItem("skeepMyId", id);
    });

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      localStream = stream;
      myVideo.srcObject = stream;
    });

    peer.on('call', call => {
      call.answer(localStream);
      call.on('stream', remoteStream => {
        theirVideo.srcObject = remoteStream;
      });
    });

    peer.on('connection', connection => {
      conn = connection;
      conn.on('data', data => {
        chatLog.innerHTML += `<div>Friend: ${data}</div>`;
      });
    });

    function startCall() {
      const targetId = document.getElementById('target-id').value.trim();
      if (!targetId) return alert("Enter a friendâ€™s ID!");

      saveToRecent(targetId);
      const call = peer.call(targetId, localStream);
      call.on('stream', remoteStream => {
        theirVideo.srcObject = remoteStream;
      });

      conn = peer.connect(targetId);
      conn.on('open', () => {
        conn.on('data', data => {
          chatLog.innerHTML += `<div>Friend: ${data}</div>`;
        });
      });
    }

    function sendMessage() {
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if (!msg) return;
      chatLog.innerHTML += `<div><b>You:</b> ${msg}</div>`;
      conn?.send(msg);
      input.value = '';
    }

    function copyMyId() {
      navigator.clipboard.writeText(myIdDisplay.textContent);
      alert("Copied your Skeep ID!");
    }

    function saveToRecent(id) {
      let recent = JSON.parse(localStorage.getItem("skeepRecent") || "[]");
      const found = recent.find(r => r.id === id);
      if (found) {
        if (found.clickedOnce) {
          const newName = prompt("Rename this contact (just for you):", found.name || id);
          if (newName) found.name = newName;
        } else {
          found.clickedOnce = true;
        }
      } else {
        recent.push({ id, name: id, clickedOnce: true });
      }
      localStorage.setItem("skeepRecent", JSON.stringify(recent));
      renderRecent();
    }

    function renderRecent() {
      const list = document.getElementById("recent-list");
      const recent = JSON.parse(localStorage.getItem("skeepRecent") || "[]");
      list.innerHTML = "<h4>ðŸ•“ Recent Contacts</h4>";
      recent.forEach(r => {
        list.innerHTML += `<div onclick="callRecent('${r.id}')">ðŸ‘¤ ${r.name || r.id}</div>`;
      });
    }

    function callRecent(id) {
      document.getElementById("target-id").value = id;
      startCall();
    }

    window.onload = renderRecent;
  </script>
</body>
</html>
