<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imagerly | AI Image Generator</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@100..900&display=swap" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #ff4d00;
            --secondary: #cf1010;
            --accent: #ffcc00;
            --bg-dark: #0a0a0a;
            --card-bg: rgba(21, 19, 8, 0.8);
        }

        body {
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'Work Sans', sans-serif;
            overflow-x: hidden;
        }

        .glass {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 77, 0, 0.1);
        }

        .fire-glow {
            box-shadow: 0 0 30px rgba(255, 77, 0, 0.3);
        }

        .fire-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .fire-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 77, 0, 0.4);
        }

        .fire-btn:active {
            transform: scale(0.95);
        }

        .prompt-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(255, 77, 0, 0.2);
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .loading-shimmer {
            background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .image-card:hover .action-overlay {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>

<body class="selection:bg-primary selection:text-black min-h-screen">

    <!-- Navbar -->
    <nav
        class="fixed top-0 left-0 right-0 z-50 bg-black/60 backdrop-blur-md border-b border-white/5 py-4 px-6 md:px-12 flex items-center justify-between">
        <div class="flex items-center gap-3 group cursor-pointer" onclick="location.href='brickburger.html'">
            <div
                class="w-8 h-8 text-primary transition-colors duration-300 group-hover:rotate-6 drop-shadow-[0_0_8px_rgba(255,77,0,0.8)]">
                <svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 20C8 12.268 15.1634 6 24 6C32.8366 6 40 12.268 40 20H8Z" fill="currentColor"></path>
                    <rect fill="#ffffff" height="12" rx="2" width="36" x="6" y="24"></rect>
                    <path d="M8 40C8 42.2091 15.1634 44 24 44C32.8366 44 40 42.2091 40 40V38H8V40Z" fill="currentColor">
                    </path>
                </svg>
            </div>
            <h1 class="text-xl font-black uppercase italic tracking-tighter">IMAGERLY</h1>
        </div>

        <div class="flex items-center gap-6">
            <div class="hidden sm:flex items-center gap-2 bg-white/5 px-4 py-1.5 rounded-full border border-white/10">
                <span class="material-symbols-outlined text-[#ffcc00] text-sm fill-1">bolt</span>
                <span id="token-count" class="text-white font-black text-xs">500</span>
                <span class="text-[8px] text-gray-500 uppercase tracking-tighter ml-1">Spark Tokens</span>
            </div>
            <a href="brickburger.html"
                class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400 hover:text-primary transition-all">Back
                to Store</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-[100px] pb-20 px-4 md:px-12 max-w-7xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">

            <!-- Sidebar Controls -->
            <aside class="lg:col-span-4 space-y-8">
                <div class="glass p-8 rounded-[2rem] border-primary/20 space-y-6">
                    <div>
                        <h2 class="text-sm font-black uppercase tracking-[0.3em] text-primary mb-4 italic">The Forge
                        </h2>
                        <form id="gen-form" class="space-y-6">
                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-bold text-gray-500 uppercase tracking-widest ml-1">Visualization
                                    Prompt</label>
                                <textarea id="prompt-input" required
                                    placeholder="A hyper-realistic fiery burger with embers floating in a 1980s neon kitchen..."
                                    class="w-full bg-black/50 border border-white/10 rounded-2xl p-5 text-sm h-32 focus:outline-none focus:border-primary transition-all resize-none prompt-input"></textarea>
                            </div>

                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest ml-1">Style
                                    Engine</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button type="button"
                                        class="style-btn active bg-primary text-black text-[10px] font-black p-3 rounded-xl border border-transparent transition-all uppercase"
                                        data-style="photorealistic">Cinematic</button>
                                    <button type="button"
                                        class="style-btn bg-white/5 text-gray-400 text-[10px] font-black p-3 rounded-xl border border-white/5 hover:border-white/10 transition-all uppercase"
                                        data-style="digital art, detailed">Illustration</button>
                                    <button type="button"
                                        class="style-btn bg-white/5 text-gray-400 text-[10px] font-black p-3 rounded-xl border border-white/5 hover:border-white/10 transition-all uppercase"
                                        data-style="cyberpunk, neon">Cyberpunk</button>
                                    <button type="button"
                                        class="style-btn bg-white/5 text-gray-400 text-[10px] font-black p-3 rounded-xl border border-white/5 hover:border-white/10 transition-all uppercase"
                                        data-style="anime, ghibli style">Anime</button>
                                </div>
                            </div>

                            <div class="space-y-2">
                                <label
                                    class="text-[10px] font-bold text-gray-500 uppercase tracking-widest ml-1">Dimensions</label>
                                <select id="ratio-select"
                                    class="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-[10px] font-black uppercase tracking-widest focus:outline-none focus:border-primary">
                                    <option value="1024x1024">Square (1:1)</option>
                                    <option value="1280x720">Landscape (16:9)</option>
                                    <option value="720x1280">Portrait (9:16)</option>
                                </select>
                            </div>

                            <button type="submit" id="ignite-btn"
                                class="w-full h-16 fire-btn rounded-2xl flex items-center justify-center gap-3 text-black font-black uppercase tracking-widest shadow-xl">
                                <span class="material-symbols-outlined">auto_fix_high</span>
                                IGNITE CREATION
                            </button>
                        </form>
                    </div>

                    <div class="pt-6 border-t border-white/5">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Recent Sparks
                            </h3>
                            <button id="clear-history"
                                class="text-[8px] text-gray-600 hover:text-primary uppercase font-bold tracking-tighter transition-colors">Clear
                                History</button>
                        </div>
                        <div id="history-rail" class="flex gap-3 overflow-x-auto pb-2 custom-scrollbar">
                            <!-- History items go here -->
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Result Area -->
            <section class="lg:col-span-8 flex flex-col gap-8">
                <div id="canvas-area"
                    class="glass rounded-[3rem] aspect-square lg:aspect-video flex flex-col items-center justify-center relative overflow-hidden border-2 border-dashed border-white/5 group">

                    <!-- Empty State -->
                    <div id="empty-state" class="flex flex-col items-center gap-6 text-center animate-pulse">
                        <div
                            class="w-24 h-24 rounded-full bg-primary/10 flex items-center justify-center border border-primary/20">
                            <span class="material-symbols-outlined text-primary text-4xl">broken_image</span>
                        </div>
                        <div class="space-y-1">
                            <h3 class="text-xl font-black uppercase italic text-white/80">Awaiting Ignition</h3>
                            <p class="text-[10px] text-gray-500 font-bold uppercase tracking-[0.3em]">Enter a prompt to
                                manifest magic</p>
                        </div>
                    </div>

                    <!-- Generation State -->
                    <div id="loading-state" class="hidden flex flex-col items-center gap-8 w-full h-full p-12">
                        <div class="w-full h-full rounded-2xl loading-shimmer border border-white/5"></div>
                        <div
                            class="absolute inset-0 flex flex-col items-center justify-center bg-black/40 backdrop-blur-sm">
                            <div class="relative w-24 h-24 mb-6">
                                <div class="absolute inset-0 border-4 border-primary/20 rounded-full"></div>
                                <div
                                    class="absolute inset-0 border-4 border-primary rounded-full border-t-transparent animate-spin">
                                </div>
                                <span
                                    class="absolute inset-0 flex items-center justify-center text-primary material-symbols-outlined animate-pulse">mode_fan</span>
                            </div>
                            <h3 class="text-lg font-black uppercase italic tracking-tighter animate-pulse">Synthesizing
                                Pixels...</h3>
                            <p id="status-update"
                                class="text-[8px] text-gray-400 font-black uppercase tracking-[0.5em] mt-2">Connecting
                                to Neural Grid</p>
                        </div>
                    </div>

                    <!-- Result State -->
                    <div id="result-state" class="hidden w-full h-full relative">
                        <img id="main-result" src="" class="w-full h-full object-contain" alt="Generated Output">

                        <!-- Floating Controls -->
                        <div
                            class="absolute bottom-10 left-1/2 -translate-x-1/2 flex items-center gap-4 bg-black/80 backdrop-blur-xl border border-white/10 p-3 rounded-2xl shadow-2xl scale-0 group-hover:scale-100 transition-transform duration-500 origin-bottom">
                            <button id="download-btn"
                                class="w-12 h-12 flex items-center justify-center bg-white/5 hover:bg-primary hover:text-black rounded-xl transition-all"
                                title="Download Image">
                                <span class="material-symbols-outlined">download</span>
                            </button>
                            <button id="share-btn"
                                class="w-12 h-12 flex items-center justify-center bg-white/5 hover:bg-primary hover:text-black rounded-xl transition-all"
                                title="Copy Link">
                                <span class="material-symbols-outlined">link</span>
                            </button>
                            <div class="w-[1px] h-8 bg-white/10 mx-2"></div>
                            <button id="variant-btn"
                                class="flex items-center gap-3 px-6 h-12 bg-primary text-black font-black uppercase text-[10px] tracking-widest rounded-xl hover:bg-secondary hover:text-white transition-all">
                                <span class="material-symbols-outlined text-sm">refresh</span>
                                New Variant
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Gallery Grid -->
                <div>
                    <h2
                        class="text-sm font-black uppercase tracking-[0.3em] text-white/50 mb-8 italic flex items-center gap-4">
                        Masterpiece Gallery
                        <div class="flex-grow h-[1px] bg-white/5"></div>
                    </h2>
                    <div id="gallery-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Gallery Items -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // API Configuration (Manifesting through Pollinations Neural Grid)
        let selectedStyle = "photorealistic";
        let tokens = 500;
        let generationHistory = JSON.parse(localStorage.getItem('imagerly_history') || '[]');

        // UI Elements
        const form = document.getElementById('gen-form');
        const promptInput = document.getElementById('prompt-input');
        const igniteBtn = document.getElementById('ignite-btn');
        const canvasArea = document.getElementById('canvas-area');
        const emptyState = document.getElementById('empty-state');
        const loadingState = document.getElementById('loading-state');
        const resultState = document.getElementById('result-state');
        const mainResult = document.getElementById('main-result');
        const galleryGrid = document.getElementById('gallery-grid');
        const historyRail = document.getElementById('history-rail');
        const tokenDisplay = document.getElementById('token-count');

        // Style Selector
        document.querySelectorAll('.style-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.style-btn').forEach(b => {
                    b.classList.remove('active', 'bg-primary', 'text-black');
                    b.classList.add('bg-white/5', 'text-gray-400', 'border-white/5');
                });
                btn.classList.add('active', 'bg-primary', 'text-black');
                btn.classList.remove('bg-white/5', 'text-gray-400', 'border-white/5');
                selectedStyle = btn.dataset.style;
            });
        });

        // Generate Logic
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            if (tokens < 20) {
                alert("Out of Spark Tokens! Tokens refresh every hour.");
                return;
            }

            // UI Transitions
            igniteBtn.disabled = true;
            igniteBtn.classList.add('opacity-50', 'pointer-events-none');
            emptyState.classList.add('hidden');
            resultState.classList.add('hidden');
            loadingState.classList.remove('hidden');

            const statusUpdate = document.getElementById('status-update');
            const messages = ["Connecting to Neural Grid", "Injecting Creative Fire", "Structuring Atoms", "Manifesting Reality"];
            let msgIdx = 0;
            const msgTimer = setInterval(() => {
                statusUpdate.textContent = messages[msgIdx++ % messages.length];
            }, 1500);

            try {
                const [width, height] = document.getElementById('ratio-select').value.split('x').map(Number);
                const fullPrompt = `${prompt}, ${selectedStyle}, masterpiece, 8k, sharp focus`;

                let imageUrl;

                // TRY IN-HOUSE FIRST
                try {
                    const response = await fetch("http://localhost:3000/generate-image", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ prompt: fullPrompt, width, height }),
                        signal: AbortSignal.timeout(3000) // 3s timeout
                    });

                    if (response.ok) {
                        const data = await response.json();
                        imageUrl = data.imageUrl;
                        console.log("Manifesting via In-House Forge");
                    }
                } catch (e) {
                    console.warn("In-House Forge Offline. Switching to Cloud Manifest Override...");
                }

                // CLOUD MANIFEST OVERRIDE (If in-house fails)
                if (!imageUrl) {
                    imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(fullPrompt)}?width=${width}&height=${height}&seed=${Math.floor(Math.random() * 999999)}&nologo=true`;
                }

                // Load the manifested image
                const img = new Image();
                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error("Manifest Timeout")), 25000);
                    img.onload = () => { clearTimeout(timeout); resolve(); };
                    img.onerror = () => { clearTimeout(timeout); reject(new Error("Manifest Load Failed")); };
                    img.src = imageUrl;
                });

                // Success!
                mainResult.src = imageUrl;
                tokens -= 20;
                updateTokens();

                clearInterval(msgTimer);
                loadingState.classList.add('hidden');
                resultState.classList.remove('hidden');

                // Save to history & gallery
                saveResult(imageUrl, prompt);

            } catch (err) {
                console.error(err);
                clearInterval(msgTimer);
                alert("The Manifestation Grid is unstable. Please check your internet or try a simpler prompt BOI!");
                loadingState.classList.add('hidden');
                emptyState.classList.remove('hidden');
            } finally {
                igniteBtn.disabled = false;
                igniteBtn.classList.remove('opacity-50', 'pointer-events-none');
            }
        });

        function saveResult(url, prompt) {
            const entry = { url, prompt, timestamp: Date.now() };
            generationHistory.unshift(entry);
            if (generationHistory.length > 20) generationHistory.pop();
            localStorage.setItem('imagerly_history', JSON.stringify(generationHistory));
            renderGallery();
            renderHistory();
        }

        function renderGallery() {
            galleryGrid.innerHTML = generationHistory.slice(0, 8).map(item => `
                <div class="image-card relative aspect-square glass rounded-2xl overflow-hidden group/item cursor-pointer" onclick="viewMain('${item.url}')">
                    <img src="${item.url}" class="w-full h-full object-cover transition-transform duration-700 group-hover/item:scale-110" loading="lazy">
                    <div class="action-overlay absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 scale-95 transition-all duration-300">
                        <span class="material-symbols-outlined text-primary">visibility</span>
                    </div>
                </div>
            `).join('');
        }

        function renderHistory() {
            historyRail.innerHTML = generationHistory.map(item => `
                <div class="w-16 h-16 rounded-xl overflow-hidden flex-shrink-0 border border-white/10 hover:border-primary cursor-pointer transition-colors" onclick="viewMain('${item.url}')">
                    <img src="${item.url}" class="w-full h-full object-cover">
                </div>
            `).join('');
        }

        function viewMain(url) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            emptyState.classList.add('hidden');
            loadingState.classList.add('hidden');
            resultState.classList.remove('hidden');
            mainResult.src = url;
        }

        function updateTokens() {
            tokenDisplay.textContent = tokens;
            tokenDisplay.parentElement.classList.add('scale-110', 'border-primary');
            setTimeout(() => tokenDisplay.parentElement.classList.remove('scale-110', 'border-primary'), 300);
        }

        // Functional buttons
        document.getElementById('download-btn').addEventListener('click', async () => {
            const res = await fetch(mainResult.src);
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `imagerly_creation_${Date.now()}.jpg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        document.getElementById('share-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(mainResult.src);
            alert("Image link copied to clipboard!");
        });

        document.getElementById('variant-btn').addEventListener('click', () => {
            form.dispatchEvent(new Event('submit'));
        });

        document.getElementById('clear-history').addEventListener('click', () => {
            if (confirm("Extinguish all history?")) {
                generationHistory = [];
                localStorage.removeItem('imagerly_history');
                renderGallery();
                renderHistory();
            }
        });

        // Initialize
        renderGallery();
        renderHistory();

        // Auto-refresh tokens
        setInterval(() => {
            if (tokens < 500) {
                tokens += 5;
                updateTokens();
            }
        }, 60000); // 5 tokens every minute
    </script>
</body>

</html>