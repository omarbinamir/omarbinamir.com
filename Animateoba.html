<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBA STUDIO | V21 ELITE (Cursor Mod)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050506;
            --ui-panel: #111114;
            --accent: #00f2ff;
            --accent-dim: rgba(0, 242, 255, 0.15);
            --border: #222228;
            --text: #ffffff;
            --rec: #ff2a54;
        }

        * { box-sizing: border-box; outline: none; user-select: none; }
        
        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif;
            display: grid;
            grid-template-columns: 280px 1fr 280px;
            grid-template-rows: 64px 1fr 220px;
            height: 100vh; overflow: hidden;
        }

        header {
            grid-column: 1/4; background: var(--ui-panel);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 24px;
            justify-content: space-between; z-index: 100;
        }

        .brand { font-weight: 900; font-size: 14px; letter-spacing: 2px; text-transform: uppercase; }
        .brand span { color: var(--accent); }

        .toolbar { display: flex; gap: 10px; }

        main {
            grid-column: 2; grid-row: 2;
            background: radial-gradient(circle, #16161a 1px, transparent 1px);
            background-size: 30px 30px;
            display: flex; align-items: center; justify-content: center;
            padding: 40px; position: relative;
        }

        .canvas-wrapper {
            width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            filter: drop-shadow(0 20px 50px rgba(0,0,0,0.5));
        }

        canvas {
            background: #000;
            max-width: 100%; max-height: 100%;
            aspect-ratio: 16 / 9;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        aside { background: var(--ui-panel); border-right: 1px solid var(--border); padding: 20px; }
        #right-sidebar { border-right: none; border-left: 1px solid var(--border); }

        .label { font-size: 10px; font-weight: 800; color: #555; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }

        footer {
            grid-column: 1/4; background: var(--ui-panel);
            border-top: 1px solid var(--border);
            display: grid; grid-template-columns: 280px 1fr;
        }

        #timeline-meta { padding: 20px; border-right: 1px solid var(--border); }

        #frames-track {
            display: flex; gap: 6px; padding: 20px;
            overflow-x: auto; align-items: flex-start;
            background: rgba(0,0,0,0.2);
        }

        .keyframe {
            min-width: 50px; height: 70px;
            background: #1a1a20; border: 1px solid #333;
            border-radius: 4px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; color: #555; cursor: pointer;
            position: relative; transition: 0.2s;
        }

        .keyframe.active {
            border-color: var(--accent); background: var(--accent-dim);
            color: var(--accent); transform: translateY(-4px);
        }

        .btn {
            background: #222228; border: 1px solid #333;
            color: #fff; padding: 10px 15px; border-radius: 6px;
            font-size: 11px; font-weight: 700; cursor: pointer;
            transition: all 0.2s; text-transform: uppercase;
        }

        .btn:hover { background: #2d2d35; border-color: var(--accent); }
        .btn-p { background: var(--accent); color: #000; border: none; }
        .btn-toggle.off { color: #555; border-color: #222; }
        .btn-rec.active { background: var(--rec); color: #fff; border: none; animation: pulse 1.5s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <header>
        <div class="brand">OBA Studio <span>v21 Elite</span></div>
        <div class="toolbar">
            <button class="btn btn-p" onclick="addCharacter()">+ Add Rig</button>
            <button class="btn btn-toggle" id="cursorBtn" onclick="toggleCursor()">Cursor: ON</button>
            <button class="btn" onclick="togglePlayback()" id="playBtn">Play Sequence</button>
            <button id="recBtn" class="btn btn-rec" onclick="exportAnimation()">Export HD</button>
        </div>
    </header>

    <aside>
        <div class="label">Layers</div>
        <div id="layer-list"></div>
    </aside>

    <main>
        <div class="canvas-wrapper">
            <canvas id="mainCanvas"></canvas>
        </div>
    </main>

    <aside id="right-sidebar">
        <div class="label">Properties</div>
        <div style="font-size:12px; line-height:2.5;">
            Format: <span style="color:var(--accent)">16:9 / 1080p</span><br>
            Cursor Visible: <span id="cursorStatus" style="color:var(--accent)">Yes</span><br>
            Motion: <span style="color:var(--accent)">Cubic Bezier</span>
        </div>
    </aside>

    <footer>
        <div id="timeline-meta">
            <button class="btn" style="width:100%" onclick="captureKeyframe()">Insert Keyframe (F)</button>
        </div>
        <div id="frames-track"></div>
    </footer>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        
        let frames = [{ data: [], mouseX: 960, mouseY: 540 }];
        let currentIdx = 0;
        let isPlaying = false;
        let showCursor = true;
        let dragTarget = null;
        let activeRig = null;
        let mouse = { x: 0, y: 0 };

        const STAGE_W = 1920;
        const STAGE_H = 1080;

        function init() {
            canvas.width = STAGE_W;
            canvas.height = STAGE_H;
            addCharacter();

            canvas.addEventListener('mousemove', e => {
                const rect = canvas.getBoundingClientRect();
                mouse.x = (e.clientX - rect.left) * (STAGE_W / rect.width);
                mouse.y = (e.clientY - rect.top) * (STAGE_H / rect.height);

                if (!isPlaying) {
                    frames[currentIdx].mouseX = mouse.x;
                    frames[currentIdx].mouseY = mouse.y;
                }

                if (dragTarget && activeRig) {
                    if (dragTarget.root) {
                        activeRig.x = mouse.x; activeRig.y = mouse.y;
                    } else {
                        dragTarget.x = mouse.x - activeRig.x;
                        dragTarget.y = mouse.y - activeRig.y;
                    }
                }
            });

            canvas.addEventListener('mousedown', () => {
                const scene = frames[currentIdx].data;
                for (let rig of scene) {
                    for (let node of Object.values(rig.bones)) {
                        if (Math.hypot((rig.x + node.x) - mouse.x, (rig.y + node.y) - mouse.y) < 45) {
                            dragTarget = node; activeRig = rig; return;
                        }
                    }
                }
            });

            window.addEventListener('mouseup', () => { dragTarget = null; activeRig = null; });
            window.addEventListener('keydown', e => { if(e.key.toLowerCase() === 'f') captureKeyframe(); });

            animate();
            renderTimeline();
        }

        function toggleCursor() {
            showCursor = !showCursor;
            const btn = document.getElementById('cursorBtn');
            const status = document.getElementById('cursorStatus');
            btn.innerText = showCursor ? "Cursor: ON" : "Cursor: OFF";
            status.innerText = showCursor ? "Yes" : "No";
            btn.classList.toggle('off', !showCursor);
        }

        function addCharacter() {
            const rig = {
                id: "Actor_" + (frames[currentIdx].data.length + 1),
                x: STAGE_W / 2, y: STAGE_H / 2 + 100,
                bones: { 
                    root: { x: 0, y: 0, root: true }, 
                    chest: { x: 0, y: -200 }, head: { x: 0, y: -300 }, 
                    l_arm: { x: -110, y: -180 }, r_arm: { x: 110, y: -180 }, 
                    l_leg: { x: -70, y: 160 }, r_leg: { x: 70, y: 160 } 
                }
            };
            frames[currentIdx].data.push(rig);
            renderTimeline();
        }

        function easeInOutCubic(t) {
            return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
        }

        function animate() {
            ctx.fillStyle = '#050506';
            ctx.fillRect(0, 0, STAGE_W, STAGE_H);

            // Draw Subtle Grid
            ctx.strokeStyle = '#111116'; ctx.lineWidth = 2;
            for(let i=0; i<STAGE_W; i+=120) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,STAGE_H); ctx.stroke(); }

            let drawState = frames[currentIdx];

            if (isPlaying && frames.length > 1) {
                const duration = 0.5; // Seconds per keyframe
                const time = (Date.now() / 1000) / duration;
                const i1 = Math.floor(time % frames.length);
                const i2 = (i1 + 1) % frames.length;
                const t = easeInOutCubic(time % 1);
                drawState = interpolate(frames[i1], frames[i2], t);
            }

            // Ghosting / Onion Skin
            if (!isPlaying && currentIdx > 0) drawRigData(frames[currentIdx-1].data, 0.1, false);
            
            drawRigData(drawState.data, 1.0, !isPlaying);
            
            // Toggleable Cursor logic
            if (showCursor) {
                drawCursor(drawState.mouseX, drawState.mouseY);
            }

            requestAnimationFrame(animate);
        }

        function interpolate(f1, f2, t) {
            const lerp = (a, b, t) => a + (b - a) * t;
            const newData = f1.data.map((rig1, i) => {
                const rig2 = f2.data[i] || rig1;
                const b = {};
                for(let k in rig1.bones) {
                    b[k] = { x: lerp(rig1.bones[k].x, rig2.bones[k].x, t), y: lerp(rig1.bones[k].y, rig2.bones[k].y, t), root: rig1.bones[k].root };
                }
                return { x: lerp(rig1.x, rig2.x, t), y: lerp(rig1.y, rig2.y, t), bones: b };
            });
            return { data: newData, mouseX: lerp(f1.mouseX, f2.mouseX, t), mouseY: lerp(f1.mouseY, f2.mouseY, t) };
        }

        function drawRigData(data, alpha, interactive) {
            data.forEach(rig => {
                ctx.save(); ctx.globalAlpha = alpha;
                const b = rig.bones;
                
                // Keep bone lengths consistent
                const solve = (p1, p2, len) => {
                    const d = Math.hypot(p2.x-p1.x, p2.y-p1.y) || 1;
                    p2.x = p1.x + (p2.x-p1.x)/d * len; p2.y = p1.y + (p2.y-p1.y)/d * len;
                };
                solve(b.root, b.chest, 200); solve(b.chest, b.head, 100);
                solve(b.chest, b.l_arm, 150); solve(b.chest, b.r_arm, 150);
                solve(b.root, b.l_leg, 200); solve(b.root, b.r_leg, 200);

                ctx.strokeStyle = "#fff"; ctx.lineWidth = 36; ctx.lineCap = 'round';
                const skeleton = [[b.root, b.chest], [b.chest, b.head], [b.chest, b.l_arm], [b.chest, b.r_arm], [b.root, b.l_leg], [b.root, b.r_leg]];
                
                skeleton.forEach(s => {
                    ctx.beginPath(); ctx.moveTo(rig.x + s[0].x, rig.y + s[0].y);
                    ctx.lineTo(rig.x + s[1].x, rig.y + s[1].y); ctx.stroke();
                });

                ctx.fillStyle = "#fff"; ctx.beginPath();
                ctx.arc(rig.x + b.head.x, rig.y + b.head.y, 60, 0, 7); ctx.fill();

                if (interactive) {
                    Object.values(b).forEach(n => {
                        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent');
                        ctx.shadowBlur = 15; ctx.shadowColor = ctx.fillStyle;
                        ctx.beginPath(); ctx.arc(rig.x + n.x, rig.y + n.y, 14, 0, 7); ctx.fill();
                        ctx.shadowBlur = 0;
                    });
                }
                ctx.restore();
            });
        }

        function drawCursor(x, y) {
            ctx.save();
            ctx.shadowBlur = 10; ctx.shadowColor = "rgba(255,255,255,0.5)";
            ctx.fillStyle = "#fff"; ctx.beginPath();
            ctx.moveTo(x, y); ctx.lineTo(x, y+35); ctx.lineTo(x+25, y+25); ctx.closePath(); ctx.fill();
            ctx.restore();
        }

        function captureKeyframe() {
            const copy = JSON.parse(JSON.stringify(frames[currentIdx]));
            frames.push(copy);
            currentIdx = frames.length - 1;
            renderTimeline();
        }

        function renderTimeline() {
            const track = document.getElementById('frames-track');
            track.innerHTML = '';
            frames.forEach((_, i) => {
                const k = document.createElement('div');
                k.className = `keyframe ${i === currentIdx ? 'active' : ''}`;
                k.innerHTML = i + 1;
                k.onclick = () => { isPlaying = false; currentIdx = i; renderTimeline(); };
                track.appendChild(k);
            });
            document.getElementById('layer-list').innerHTML = frames[currentIdx].data.map(r => `<div style="padding:12px; border-bottom:1px solid #222; font-size:11px; color:#888;">RIG: ${r.id}</div>`).join('');
        }

        function togglePlayback() { 
            isPlaying = !isPlaying; 
            document.getElementById('playBtn').innerText = isPlaying ? "Stop" : "Play Sequence";
        }

        async function exportAnimation() {
            const stream = canvas.captureStream(60);
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 20000000 });
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = 'OBA_PRO_CLEAN.mp4'; a.click();
            };

            document.getElementById('recBtn').classList.add('active');
            recorder.start();
            isPlaying = true;

            setTimeout(() => {
                recorder.stop();
                isPlaying = false;
                document.getElementById('recBtn').classList.remove('active');
            }, frames.length * 500);
        }

        init();
    </script>
</body>
</html>